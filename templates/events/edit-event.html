{% extends "layout.html" %}
{% load static %}
{% load text_filters %}
{% load events %}

{% block title %}
    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {{ event.title }} ‚Äî {{ block.super }}
{% endblock %}

{% block content %}
    <div class="content event">
        <div class="event-sidebar">
            <div class="event-edit-menu">
                <a href="{% url "edit_event" event.id %}" class="event-edit-menu-item {% if section == "event" %}active{% endif %}">
                    üìù –°–æ–±—ã—Ç–∏–µ
                </a>
                <a href="{% url "edit_event_ticket_types" event.id %}" class="event-edit-menu-item {% if section == "ticket-types" %}active{% endif %}">
                    üéüÔ∏è –¢–∏–ø—ã –±–∏–ª–µ—Ç–æ–≤
                </a>
                <a href="{% url "edit_event_tickets_sold" event.id %}" class="event-edit-menu-item {% if section == "tickets-sold" %}active{% endif %}">
                    üí∞ –ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã
                </a>
                <a href="{% url "edit_event_notifications" event.id %}" class="event-edit-menu-item {% if section == "notifications" %}active{% endif %}">
                    üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                </a>
            </div>

            <div class="event-edit-button">
                <a href="{% url "show_event" event.id %}" class="button">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–æ–±—ã—Ç–∏—é</a>
            </div>
        </div>

        <div class="event-main animate-on-load">
            {% if section == "event" %}
                <div class="event-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ</div>

                <div class="block event-edit-form">
                    <form method="POST" action="{% url "edit_event" event.id %}">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="{{ form.title.id_for_label }}">{{ form.title.label }}</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="form-error">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="form-error">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.location.id_for_label }}">{{ form.location.label }}</label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <div class="form-error">{{ form.location.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.location_url.id_for_label }}">{{ form.location_url.label }}</label>
                                {{ form.location_url }}
                                {% if form.location_url.errors %}
                                    <div class="form-error">{{ form.location_url.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.sale_starts_at.id_for_label }}">{{ form.sale_starts_at.label }}</label>
                                {{ form.sale_starts_at }}
                                {% if form.sale_starts_at.errors %}
                                    <div class="form-error">{{ form.sale_starts_at.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.sale_ends_at.id_for_label }}">{{ form.sale_ends_at.label }}</label>
                                {{ form.sale_ends_at }}
                                {% if form.sale_ends_at.errors %}
                                    <div class="form-error">{{ form.sale_ends_at.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.event_starts_at.id_for_label }}">{{ form.event_starts_at.label }}</label>
                                {{ form.event_starts_at }}
                                {% if form.event_starts_at.errors %}
                                    <div class="form-error">{{ form.event_starts_at.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.event_ends_at.id_for_label }}">{{ form.event_ends_at.label }}</label>
                                {{ form.event_ends_at }}
                                {% if form.event_ends_at.errors %}
                                    <div class="form-error">{{ form.event_ends_at.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.icon.id_for_label }}">{{ form.icon.label }}</label>
                                {{ form.icon }}
                                {% if form.icon.errors %}
                                    <div class="form-error">{{ form.icon.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.image.id_for_label }}">{{ form.image.label }}</label>
                                {{ form.image }}
                                {% if form.image.errors %}
                                    <div class="form-error">{{ form.image.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="{{ form.intro.id_for_label }}">{{ form.intro.label }}</label>
                            {{ form.intro }}
                            {% if form.intro.errors %}
                                <div class="form-error">{{ form.intro.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="form-group">
                            <label for="{{ form.managers.id_for_label }}">{{ form.managers.label }}</label>
                            {{ form.managers }}
                            {% if form.managers.errors %}
                                <div class="form-error">{{ form.managers.errors }}</div>
                            {% endif %}
                            <div class="form-help">–°–ø–∏—Å–æ–∫ slug'–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.contact_url.id_for_label }}">{{ form.contact_url.label }}</label>
                                {{ form.contact_url }}
                                {% if form.contact_url.errors %}
                                    <div class="form-error">{{ form.contact_url.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group">
                                <label for="{{ form.waitlist_url.id_for_label }}">{{ form.waitlist_url.label }}</label>
                                {{ form.waitlist_url }}
                                {% if form.waitlist_url.errors %}
                                    <div class="form-error">{{ form.waitlist_url.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="{{ form.index.id_for_label }}">{{ form.index.label }}</label>
                                {{ form.index }}
                                {% if form.index.errors %}
                                    <div class="form-error">{{ form.index.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group form-group-checkbox">
                                <label>
                                    {{ form.is_visible }}
                                    {{ form.is_visible.label }}
                                </label>
                                {% if form.is_visible.errors %}
                                    <div class="form-error">{{ form.is_visible.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="form-group form-group-checkbox">
                                <label>
                                    {{ form.is_sold_out }}
                                    {{ form.is_sold_out.label }}
                                </label>
                                {% if form.is_sold_out.errors %}
                                    <div class="form-error">{{ form.is_sold_out.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="button button-blue">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        </div>
                    </form>
                </div>

            {% elif section == "ticket-types" %}
                <div class="event-title">–¢–∏–ø—ã –±–∏–ª–µ—Ç–æ–≤</div>

                <div class="block">
                    <div class="block-header">üéüÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∏–ø–∞–º–∏ –±–∏–ª–µ—Ç–æ–≤</div>
                    <div class="block-description">
                        <a href="{% url "edit_ticket_type_new" event.id %}" class="button button-blue">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø –±–∏–ª–µ—Ç–∞</a>
                    </div>
                </div>

                {% if ticket_types %}
                    {% for ticket_type in ticket_types %}
                        <div class="block ticket-type-edit">
                            <div class="ticket-type-edit-header">
                                <div class="ticket-type-edit-info">
                                    <div class="ticket-type-name">{{ ticket_type.name }}</div>
                                    {% if ticket_type.description %}
                                        <div class="ticket-type-description">{{ ticket_type.description }}</div>
                                    {% endif %}
                                    <div class="ticket-type-stats">
                                        {% if ticket_type.price and ticket_type.price > 0 %}
                                            <span class="ticket-type-price">{{ ticket_type.price|floatformat }}{% if ticket_type.currency %} {{ ticket_type.currency }}{% endif %}</span>
                                        {% else %}
                                            <span class="ticket-type-price">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</span>
                                        {% endif %}
                                        {% if ticket_type.limit_quantity > 0 %}
                                            <span class="ticket-type-limit">–õ–∏–º–∏—Ç: {{ ticket_type.limit_quantity }}</span>
                                        {% endif %}
                                        <span class="ticket-type-sold">–ü—Ä–æ–¥–∞–Ω–æ: {{ ticket_type.tickets_sold }}</span>
                                    </div>
                                </div>
                                <div class="ticket-type-edit-actions">
                                    <a href="{% url "edit_ticket_type" event.id ticket_type.id %}" class="button">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                                    <form method="POST" action="{% url "delete_ticket_type" event.id ticket_type.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="button button-red" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–∏–ø –±–∏–ª–µ—Ç–∞ ¬´{{ ticket_type.name }}¬ª?{% if ticket_type.tickets_sold > 0 %}\n\n–í–Ω–∏–º–∞–Ω–∏–µ: —É–∂–µ –ø—Ä–æ–¥–∞–Ω–æ {{ ticket_type.tickets_sold }} –±–∏–ª–µ—Ç–æ–≤ —ç—Ç–æ–≥–æ —Ç–∏–ø–∞!{% endif %}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="block">
                        <div class="block-description">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–∏–ø–æ–≤ –±–∏–ª–µ—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</div>
                    </div>
                {% endif %}

            {% elif section == "tickets-sold" %}
                <div class="event-title">–ü—Ä–æ–¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç—ã</div>

                {% if ticket_stats %}
                    <div class="block">
                        <div class="block-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º</div>
                        <div class="ticket-stats-list">
                            {% for stat in ticket_stats %}
                                <div class="ticket-stat-item">
                                    <span class="ticket-stat-name">{{ stat.ticket_type__name|default:"–ë–µ–∑ —Ç–∏–ø–∞" }}</span>
                                    <span class="ticket-stat-count">{{ stat.count }} —à—Ç.</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {% if tickets %}
                    <div class="block">
                        <div class="block-header">üíé –°–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤</div>
                        <div class="tickets-list">
                            {% for ticket in tickets %}
                                <div class="ticket-item">
                                    <div class="ticket-item-info">
                                        <div class="ticket-item-code">{{ ticket.code }}</div>
                                        <div class="ticket-item-type">{{ ticket.ticket_type.name }}</div>
                                        {% if ticket.user %}
                                            <div class="ticket-item-user">
                                                <span class="avatar" style="background-image: url('{{ ticket.user.avatar }}');"></span>
                                                <span>{{ ticket.user.full_name }}</span>
                                            </div>
                                        {% elif ticket.customer_email %}
                                            <div class="ticket-item-email">{{ ticket.customer_email }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="ticket-item-date">{{ ticket.created_at|date:"d.m.Y H:i" }}</div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="block">
                        <div class="block-description">–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤.</div>
                    </div>
                {% endif %}

            {% elif section == "notifications" %}
                <div class="event-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>

                {% if subscriptions %}
                    <div class="block">
                        <div class="block-header">üîî –ü–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
                        <div class="subscriptions-list">
                            {% for subscription in subscriptions %}
                                <div class="subscription-item">
                                    <div class="subscription-info">
                                        {% if subscription.user %}
                                            <div class="subscription-user">
                                                <span class="avatar" style="background-image: url('{{ subscription.user.avatar }}');"></span>
                                                <span>{{ subscription.user.full_name }}</span>
                                            </div>
                                        {% endif %}
                                        <div class="subscription-email">{{ subscription.email }}</div>
                                        <div class="subscription-topic">{{ subscription.topic }}</div>
                                    </div>
                                    <div class="subscription-actions">
                                        <div class="subscription-date">{{ subscription.created_at|date:"d.m.Y H:i" }}</div>
                                        <form method="POST" action="{% url "delete_notification" event.id subscription.id %}" style="display: inline;">
                                            {% csrf_token %}
                                            <button type="submit" class="button button-red button-small" onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è {{ subscription.email }} ({{ subscription.topic }})?')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                        </form>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="block">
                        <div class="block-description">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.</div>
                    </div>
                {% endif %}

            {% endif %}
        </div>
    </div>
{% endblock %}
